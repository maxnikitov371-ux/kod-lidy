name: AI - Docs and Code (separated)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "What to run: docs (documentation-only) or code (code changes)"
        required: true
        default: "docs"
        type: choice
        options:
          - docs
          - code

# Default permissions are minimal. We override per job.
permissions:
  contents: read

jobs:
  docs_agent:
    name: Docs agent (documentation-only)
    if: ${{ github.event.inputs.mode == 'docs' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Codex for docs only
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}

          prompt: |
            You are a documentation-only agent.
            You may read the entire repository, but you must ONLY create/edit:
            - AGENTS.md
            - docs/ai/**
            Do not modify any other files.
            Produce clear, structured docs for Codex to follow:
            - docs/ai/PROJECT.md
            - docs/ai/ARCHITECTURE.md
            - docs/ai/DATA_SCHEMA.md
            - docs/ai/CODEX_RULES.md
            Follow existing style and constraints in AGENTS.md.

      - name: Guardrail - fail if non-doc files changed
        shell: bash
        run: |
          set -euo pipefail
          CHANGED="$(git diff --name-only)"
          echo "Changed files:"
          echo "$CHANGED"

          # Allowed:
          # - AGENTS.md
          # - docs/ai/**  (you can widen to docs/** if you want)
          DISALLOWED="$(echo "$CHANGED" | grep -Ev '^(AGENTS\.md|docs/ai/)' || true)"

          if [ -n "$DISALLOWED" ]; then
            echo ""
            echo "ERROR: Non-doc files were modified. This job is docs-only."
            echo "$DISALLOWED"
            exit 1
          fi

      - name: Create PR with docs updates
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: "docs(ai): update Codex documentation"
          title: "docs(ai): update Codex documentation"
          body: |
            Automated documentation update.
            This PR must only touch AGENTS.md and docs/ai/**.
          branch: ai/docs-updates
          delete-branch: true

  codex_code:
    name: Codex (code changes)
    if: ${{ github.event.inputs.mode == 'code' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Codex for code changes
        uses: openai/codex-action@v1
        with:
          openai_api_key: ${{ secrets.OPENAI_API_KEY }}
          prompt: |
            You are the coding agent.
            Read and follow:
            - AGENTS.md
            - docs/ai/PROJECT.md
            - docs/ai/ARCHITECTURE.md
            - docs/ai/DATA_SCHEMA.md
            - docs/ai/CODEX_RULES.md
            Make safe, minimal code changes. Avoid breaking the site.

      - name: Create PR with code updates
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: "chore: codex code update"
          title: "chore: codex code update"
          body: |
            Automated code update by Codex.
            Must follow docs in docs/ai/** and AGENTS.md.
          branch: ai/codex-code-updates
          delete-branch: true
